# 权限管理系统规划

## 1. 表结构设计

### 1.1 现有表结构

#### sys_user (用户表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | int | 用户ID |
| username | varchar | 用户名 |
| password | varchar | 密码 |
| nickname | varchar | 昵称 |
| avatar | varchar | 头像 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### sys_role (角色表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | int | 角色ID |
| role_name | varchar | 角色名称 |
| description | text | 角色描述 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### sys_menu (菜单表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | int | 菜单ID |
| name | varchar | 菜单名称 |
| path | varchar | 菜单路径 |
| component | varchar | 组件路径 |
| icon | varchar | 菜单图标 |
| parent_id | int | 上级菜单ID |
| status | tinyint | 菜单状态(1:启用,0:禁用) |
| show_link | tinyint | 是否显示链接(1:显示,0:隐藏) |
| is_frame | tinyint | 是否为外部框架(1:是,0:否) |
| frame_src | varchar | 外部框架地址 |
| sort | int | 排序 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### sys_permission (权限表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | int | 权限ID |
| code | varchar | 权限代码 |
| name | varchar | 权限名称 |
| menu_id | int | 关联菜单ID |
| type | tinyint | 权限类型(1:菜单权限,2:按钮权限) |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### sys_user_role (用户-角色关联表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| user_id | int | 用户ID |
| role_id | int | 角色ID |

#### sys_role_menu (角色-菜单关联表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| role_id | int | 角色ID |
| menu_id | int | 菜单ID |

#### sys_role_permission (角色-权限关联表)
| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| role_id | int | 角色ID |
| permission_id | int | 权限ID |

## 2. 权限分类

### 2.1 菜单权限
- 控制用户是否能够看到某个菜单
- 控制用户是否能够访问某个页面
- 与sys_menu表关联

### 2.2 按钮权限
- 控制用户是否能够看到某个按钮
- 控制用户是否能够执行某个操作
- 与sys_permission表关联，type=2

## 3. 权限代码设计

### 3.1 权限代码命名规范

#### 菜单权限代码
```
menu:{menu_path}
例如：menu:system/enterprise/company
```

#### 按钮权限代码
```
btn:{menu_path}:{action}
例如：btn:system/enterprise/company:add
```

### 3.2 常见按钮权限代码
- add: 新增
- edit: 编辑
- delete: 删除
- view: 查看
- export: 导出
- import: 导入
- approve: 审批

## 4. 菜单和权限的关联关系

### 4.1 菜单权限关联
- 每个菜单自动生成对应的菜单权限
- 角色通过关联菜单权限来控制用户是否能够看到和访问该菜单

### 4.2 按钮权限关联
- 每个页面的按钮需要在权限表中注册对应的按钮权限
- 角色通过关联按钮权限来控制用户是否能够看到和使用该按钮

### 4.3 动态菜单加载
- 登录时，根据用户所属角色的权限动态生成菜单树
- 只显示用户拥有权限的菜单
- 对于有子菜单的父菜单，只有当用户至少拥有一个子菜单的权限时才显示

## 5. 前端权限控制

### 5.1 动态菜单加载
- 登录成功后，调用后端API获取用户拥有的菜单权限
- 根据菜单权限生成前端路由和菜单树
- 动态添加路由到Vue Router

### 5.2 按钮权限控制
- 使用v-auth指令控制按钮的显示和隐藏
- 在前端存储用户拥有的按钮权限列表
- 根据权限列表判断按钮是否显示

### 5.3 权限判断工具函数
- hasPerms(permissionCode): 判断用户是否拥有指定权限
- hasAnyPerms(permissionCodes): 判断用户是否拥有任意一个指定权限
- hasAllPerms(permissionCodes): 判断用户是否拥有所有指定权限

## 6. 后端API接口

### 6.1 权限管理API
- 获取菜单树: GET /api/permission/menus
- 获取权限列表: GET /api/permission/permissions
- 角色权限分配: POST /api/permission/assign

### 6.2 用户权限API
- 获取用户路由: GET /api/permission/routes
- 获取用户权限: GET /api/permission/user-permissions

## 7. 权限管理流程

### 7.1 菜单管理流程
1. 创建菜单时，自动生成对应的菜单权限
2. 编辑菜单时，更新对应的菜单权限
3. 删除菜单时，同时删除对应的菜单权限和关联的按钮权限

### 7.2 角色管理流程
1. 创建角色时，为角色分配菜单权限和按钮权限
2. 编辑角色时，更新角色的权限分配
3. 删除角色时，同时删除角色与权限的关联关系

### 7.3 用户登录流程
1. 用户登录成功后，获取用户信息和所属角色
2. 根据角色获取用户拥有的菜单权限和按钮权限
3. 根据菜单权限动态生成前端路由和菜单树
4. 将按钮权限存储到前端状态管理中，用于按钮权限控制

## 8. 权限管理最佳实践

### 8.1 权限设计原则
- 最小权限原则: 用户只拥有完成工作所需的最小权限
- 权限继承原则: 子菜单权限继承父菜单权限
- 权限分离原则: 不同功能的权限应该分离管理

### 8.2 性能优化
- 缓存用户权限: 登录后将用户权限缓存到前端，减少API调用
- 批量权限判断: 避免频繁的权限判断调用
- 权限预加载: 登录时一次性获取所有权限，避免后续重复请求

### 8.3 安全性考虑
- 前端权限控制只是辅助，后端必须进行权限验证
- 敏感操作必须在后端进行权限检查
- 权限变更时，及时更新用户权限缓存

## 9. 实施计划

### 9.1 后端实施
1. 完善表结构设计
2. 实现权限管理API接口
3. 实现用户权限获取API接口
4. 实现菜单和权限的关联逻辑

### 9.2 前端实施
1. 实现动态菜单加载逻辑
2. 实现按钮权限控制指令
3. 完善前端权限判断工具函数
4. 实现权限管理页面

### 9.3 测试验证
1. 测试不同角色的菜单显示
2. 测试不同角色的按钮权限
3. 测试权限变更后的实时更新
4. 测试系统性能和安全性

## 10. 总结

通过以上规划，系统将实现完整的RBAC权限管理功能，包括：
- 基于角色的访问控制
- 动态菜单加载
- 按钮级别的权限控制
- 统一的权限管理界面
- 完善的权限验证机制

这样的权限管理系统将为企业提供灵活、安全、高效的权限控制方案，满足不同企业的权限管理需求。